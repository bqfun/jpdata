- init:
    assign:
      - projectId: $${sys.get_env("GOOGLE_CLOUD_PROJECT_ID")}
      - batchApiUrl: $${"https://batch.googleapis.com/v1/projects/" + projectId + "/locations/us-central1/jobs"}
      - jobId: $${"job-gbizinfo-" + string(int(sys.now()))}
      - bucket: ${bucket}
- createAndRunBatchJob:
    call: http.post
    args:
      url: $${batchApiUrl}
      query:
        job_id: $${jobId}
      headers:
        Content-Type: application/json
      auth:
        type: OAuth2
      body:
        taskGroups:
          taskSpec:
            runnables:
              - script:
                  text: $${"curl https://info.gbiz.go.jp/hojin/Download -d downenc=UTF-8 -d downfile=$${DOWNFILE} -d downtype=csv | gsutil cp - gs://" + bucket + "/gbizinfo/$${OBJECT}.csv"}
          taskEnvironments:
            - variables:
                OBJECT: basic
                DOWNFILE: "7"
            - variables:
                OBJECT: certification
                DOWNFILE: "8"
            - variables:
                OBJECT: commendation
                DOWNFILE: "9"
            - variables:
                OBJECT: subsidy
                DOWNFILE: "10"
            - variables:
                OBJECT: procurement
                DOWNFILE: "11"
            - variables:
                OBJECT: patent
                DOWNFILE: "12"
            - variables:
                OBJECT: finance
                DOWNFILE: "13"
            - variables:
                OBJECT: workplace
                DOWNFILE: "14"

        allocationPolicy:
          instances:
            - policy:
                machineType: e2-micro
                provisioningModel: SPOT

        logsPolicy:
          destination: CLOUD_LOGGING
