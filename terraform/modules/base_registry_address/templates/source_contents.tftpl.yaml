- init:
    assign:
      - projectId: $${sys.get_env("GOOGLE_CLOUD_PROJECT_ID")}
      - batchApiUrl: $${"https://batch.googleapis.com/v1/projects/" + projectId + "/locations/us-central1/jobs"}
      - jobId: $${"job-base-registry-address-" + string(int(sys.now()))}
      - bucket: ${bucket}
      - repositoryId: ${repositoryId}
      - location: ${location}
- createAndRunBatchJob:
    call: http.post
    args:
      url: $${batchApiUrl}
      query:
        job_id: $${jobId}
      headers:
        Content-Type: application/json
      auth:
        type: OAuth2
      body:
        taskGroups:
          taskSpec:
            runnables:
              - container:
                  imageUri: $${location + "-docker.pkg.dev/" + projectId + "/" + repositoryId + "/etl:latest"}
                environment:
                  variables:
                    SOURCE_CONTENTS: '
                      {
                        "extract": {
                          "method": "GET",
                          "url": "https://gov-csv-export-public.s3.ap-northeast-1.amazonaws.com/mt_town/mt_town_all.csv.zip"
                        },
                        "transform": [
                          {
                            "call": "unzip"
                          }
                        ],
                        "load": {
                          "bucket": "jpdata-source-eventarc",
                          "object": "base_registry_address/mt_town_all.csv",
                          "name": "mt_town_all.csv"
                        }
                      }'

        allocationPolicy:
          instances:
            - policy:
                machineType: e2-micro
                provisioningModel: SPOT

        logsPolicy:
          destination: CLOUD_LOGGING
