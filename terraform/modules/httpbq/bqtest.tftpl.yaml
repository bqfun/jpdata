- query:
    call: googleapis.bigquery.v2.jobs.query
    args:
      projectId: $${sys.get_env("GOOGLE_CLOUD_PROJECT_ID")}
      body:
        query: |
          SELECT
            LOGICAL_AND(expected_table_name IS NOT NULL)
            AND LOGICAL_AND(table_name IS NOT NULL)
            AND CURRENT_TIMESTAMP() - INTERVAL 24 HOUR < MIN(creation_time)
          FROM
            UNNEST(${table_names}) as expected_table_name
          FULL JOIN
            ${dataset_id}.INFORMATION_SCHEMA.TABLES
          ON
            expected_table_name = table_name
        useLegacySql: false
    result: queryResult
- access_secret:
    call: googleapis.secretmanager.v1.projects.secrets.versions.access
    args:
      name: ${slack_webhook_url_secret_id}/versions/latest
    result: base64_encoded_secret
- notify:
    switch:
      - condition: $${queryResult.rows[0].f[0].v != "true"}
        steps:
          - step:
              call: http.post
              args:
                url: $${text.decode(base64.decode(base64_encoded_secret.payload.data))}
                body:
                  text: ${dataset_id}が更新できていません！